---
title: Vue 源码阅读：
date: 2020-07-01T16:03:08
tags:
  - 源码阅读
  - Vue 源码阅读
  - vue
---

## 前言

在 `beforeCreate` 之后，就要进入 Vue 一个比较核心的功能模块，就是响应式系统。

> 在进入真正的响应式系统源码前，建议阅读先阅读 [实现 Vue 2 响应式系统](./2020-06-30-vue2-reactivity.md)。
> 
> 在这篇文章中，我用 30 行代码实现了一个响应式系统的原型，用 100 行不到的代码模拟了 Vue 源码中响应式系统的代码组织方式。
> 
> 之后在阅读 Vue 的源码能让你更快理清思路

## 例子

之前的代码是通过 `new Vue()` 这一过程来讲解的。但进入响应式系统后就需要有数据，从下面的例子开始

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Vue</title>
</head>
<body>
  <div id="app"></div>
  <script src="./vue.runtime.js"></script>
  <script>
    var app = new Vue({
      data() {
        return {
          message: 'hello vue'
        }
      },
      render: function (createElement) {
        return createElement('div', this.message)
      }
    }).$mount('#app')
  </script>
</body>
</html>
```

这里 `data` 方法返回的对象仅包含 `message` 属性，`render` 方法穿件了一个 `div`，内容为 `message`。最后将该实例挂载到 `id` 为 `app` 的 `DOM` 节点上。

## mergeOptions 的变动

### data 的 merge

> 太长不看版：mergeOptions 在 merge `data` 字段时执行对应 merge 策略，主要是用来处理多个 `data` 的情况（比如 mixin 中含有 data）。但例子中只有一个 `data`，因此效果上  merge 后的 `$options.data` 等同于 `data`

在配置对象中新增了 `data` 字段后，执行 `mergeOptions` 就出现了一些不同的地方

```js
export function mergeOptions (
  parent: Object,
  child: Object,
  vm?: Component
): Object {
  // ...

  const options = {}
  let key
  for (key in parent) {
    mergeField(key)
  }
  for (key in child) {
    if (!hasOwn(parent, key)) {
      mergeField(key)
    }
  }
  function mergeField (key) {
    const strat = strats[key] || defaultStrat
    options[key] = strat(parent[key], child[key], vm, key)
  }
  return options
}
```

这里在 `mergeField(key)` 时会调用到 `mergeField('data')`，也就是在 `mergeField` 中会调用到 `strats['data']`，而 `strats['data']` 内容如下

```js
strats.data = function (
  parentVal: any,
  childVal: any,
  vm?: Component
): ?Function {
  if (!vm) {
    if (childVal && typeof childVal !== 'function') {
      process.env.NODE_ENV !== 'production' && warn(
        'The "data" option should be a function ' +
        'that returns a per-instance value in component ' +
        'definitions.',
        vm
      )

      return parentVal
    }
    return mergeDataOrFn(parentVal, childVal)
  }

  return mergeDataOrFn(parentVal, childVal, vm)
}
```

这里返回 `mergeDataOrFn()` 的结果

```js
export function mergeDataOrFn (
  parentVal: any,
  childVal: any,
  vm?: Component
): ?Function {
  if (!vm) {
    // in a Vue.extend merge, both should be functions
    if (!childVal) {
      return parentVal
    }
    if (!parentVal) {
      return childVal
    }
    // when parentVal & childVal are both present,
    // we need to return a function that returns the
    // merged result of both functions... no need to
    // check if parentVal is a function here because
    // it has to be a function to pass previous merges.
    return function mergedDataFn () {
      return mergeData(
        typeof childVal === 'function' ? childVal.call(this, this) : childVal,
        typeof parentVal === 'function' ? parentVal.call(this, this) : parentVal
      )
    }
  } else {
    return function mergedInstanceDataFn () {
      // instance merge
      const instanceData = typeof childVal === 'function'
        ? childVal.call(vm, vm)
        : childVal
      const defaultData = typeof parentVal === 'function'
        ? parentVal.call(vm, vm)
        : parentVal
      if (instanceData) {
        return mergeData(instanceData, defaultData)
      } else {
        return defaultData
      }
    }
  }
}
```

进入 `mergeDataOrFn`，发现返回了一个函数 `mergedInstanceDataFn`，说明 `$options.data` 最终等于 `mergedInstanceDataFn`

`mergedInstanceDataFn` 执行时分别调用了 `data` 方法，然后调用 `mergeData` 对各自的结果进行了 merge

### render 的 merge

render 的 merge 执行了 `defaultStrat`